<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Cuncunul - Iniciar Sesión</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="resources/cero.ico" type="image/x-icon" />

    <!-- W3.CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Kurale&family=Quattrocento+Sans&family=Raleway:wght@400&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome para íconos de redes sociales -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />

    <link rel="stylesheet" href="restaurantStyle.css" />
    <link rel="stylesheet" href="loginStyle.css" />
    <link rel="stylesheet" href="notification.css" />
    <link rel="stylesheet" href="chat.css" />
    <!-- Script de Ajax -->
    <script src="ajax_handler.js"></script>
  </head>

  <body class="background">
    <!-- Header -->
    <div class="w3-top" id="navbar">
      <div class="w3-bar w3-padding w3-card">
        <a href="index.html" class="w3-bar-item w3-button logo-container">
          <img
            src="resources/cero.ico"
            alt="Logo Cuncunul"
            class="header-logo"
          />
          <span style="font-family: kurale, serif; font-size: larger"
            >Cuncunul</span
          >
        </a>
        <div class="w3-right w3-hide-small">
          <a href="index.html#about" class="w3-bar-item w3-button"
            >Sobre nosotros</a
          >
          <a href="menu.html" class="w3-bar-item w3-button">Menú</a>
          <a href="index.html#contact" class="w3-bar-item w3-button"
            >Contacto</a
          >
        </div>
      </div>
    </div>

    <!-- Contenedor de Login -->
    <div class="login-container">
      <div class="login-header">
        <img src="resources/cero.ico" alt="Logo" class="login-icon" />
        <h2 id="form-title">Iniciar Sesión</h2>
      </div>
      <!-- Formulario de Login -->
      <form id="login-form">
        <div class="form-group">
          <label for="email">Correo Electrónico</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="password">Contraseña</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-control"
            required
          />
        </div>
        <button type="submit" class="btn">Iniciar Sesión</button>

        <div class="separator-text">o continuar con</div>

        <div class="social-login">
          <button type="button" class="social-btn google-btn">
            <i class="fab fa-google"></i> Google
          </button>
          <button type="button" class="social-btn facebook-btn">
            <i class="fab fa-facebook-f"></i> Facebook
          </button>
          <button type="button" class="social-btn apple-btn">
            <i class="fab fa-apple"></i> Apple
          </button>
        </div>

        <div class="register-link">
          ¿No tienes cuenta?
          <span class="form-toggle" onclick="toggleForm()">Regístrate</span>
        </div>
      </form>

      <!-- Formulario de Registro -->
      <form id="register-form">
        <div class="form-group">
          <label for="reg-name">Nombre Completo</label>
          <input
            type="text"
            id="reg-name"
            name="name"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="reg-email">Correo Electrónico</label>
          <input
            type="email"
            id="reg-email"
            name="email"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="reg-telefono">Teléfono de Contacto</label>
          <input
            type="tel"
            id="reg-telefono"
            name="telefono"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="reg-password">Contraseña</label>
          <input
            type="password"
            id="reg-password"
            name="password"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="reg-confirm">Confirmar Contraseña</label>
          <input
            type="password"
            id="reg-confirm"
            name="confirm_password"
            class="form-control"
            required
          />
        </div>
        <p style="color: #e3ba7e; font-size: 0.85rem; margin-top: -10px; margin-bottom: 15px; text-align: center;">
          Después de registrarte, recibirás un código de verificación que deberás ingresar para activar tu cuenta.
        </p>
        <button type="submit" class="btn">Registrarse</button>

        <div class="register-link">
          ¿Ya tienes cuenta?
          <span class="form-toggle" onclick="toggleForm()">Inicia Sesión</span>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <footer>
      <img src="resources/cero.ico" alt="Logo Cuncunul" class="header-logo" />
    </footer>

    <script>
      function toggleForm() {
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        const formTitle = document.getElementById("form-title");

        if (loginForm.style.display === "none") {
          // Mostrar formulario de login
          loginForm.style.display = "block";
          registerForm.style.display = "none";
          formTitle.textContent = "Iniciar Sesión";
        } else {
          // Mostrar formulario de registro
          loginForm.style.display = "none";
          registerForm.style.display = "block";
          formTitle.textContent = "Registrarse";
        }
      }

      // Función para mostrar notificaciones
      function showNotification(message, type = "success") {
        // Crear elemento de notificación
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;

        // Añadir al DOM
        document.body.appendChild(notification);

        // Mostrar con animación
        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        // Eliminar después de 3 segundos
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // Manejar envío del formulario de login con AJAX directo
      document
        .getElementById("login-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Agregar clase de carga
          this.classList.add("form-loading");

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          // Crear y configurar la solicitud XHR directamente
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "ajax_login.php", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );
          xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

          xhr.onload = function () {
            // Quitar clase de carga
            document
              .getElementById("login-form")
              .classList.remove("form-loading");

            console.log("Respuesta recibida:", xhr.responseText);

            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const response = JSON.parse(xhr.responseText);

                if (response.success) {
                  showNotification(response.message, "success");
                  // Redireccionar después de un breve retraso
                  setTimeout(function () {
                    window.location.href = response.redirect;
                  }, 1000);
                } else {
                  showNotification(response.message, "error");
                }
              } catch (e) {
                console.error("Error al procesar respuesta:", e);
                console.log("Respuesta recibida:", xhr.responseText);
                showNotification(
                  "Error al procesar la respuesta del servidor",
                  "error"
                );
              }
            } else {
              showNotification("Error de conexión", "error");
            }
          };

          xhr.onerror = function () {
            // Quitar clase de carga
            document
              .getElementById("login-form")
              .classList.remove("form-loading");
            showNotification("Error de conexión", "error");
          };

          // Preparar datos
          const formData =
            "email=" +
            encodeURIComponent(email) +
            "&password=" +
            encodeURIComponent(password);

          // Enviar solicitud
          xhr.send(formData);
        });

      // Manejar envío del formulario de registro con AJAX directo
      document
        .getElementById("register-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Agregar clase de carga
          this.classList.add("form-loading");

          const name = document.getElementById("reg-name").value;
          const email = document.getElementById("reg-email").value;
          const telefono = document.getElementById("reg-telefono").value;
          const password = document.getElementById("reg-password").value;
          const confirmPassword = document.getElementById("reg-confirm").value;

          // Validación básica en el lado del cliente
          if (password !== confirmPassword) {
            showNotification("Las contraseñas no coinciden", "error");
            this.classList.remove("form-loading");
            return;
          }

          // Crear y configurar la solicitud XHR
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "ajax_register.php", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );
          xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

          xhr.onload = function () {
            // Quitar clase de carga
            document
              .getElementById("register-form")
              .classList.remove("form-loading");

            console.log("Respuesta recibida:", xhr.responseText);

            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const response = JSON.parse(xhr.responseText);

                if (response.success) {
                  // Mostrar el código en un mensaje específico
                  let mensaje = response.message;
                  if (response.codigo) {
                    mensaje = `Registro exitoso. Anota tu código de verificación: ${response.codigo}`;
                  }
                  showNotification(mensaje, "success");
                  
                  // Redireccionar después de un breve retraso
                  setTimeout(function () {
                    window.location.href = response.redirect;
                  }, 3000); // Dar más tiempo para ver el código
                } else {
                  showNotification(response.message, "error");
                }
              } catch (e) {
                console.error("Error al procesar respuesta:", e);
                console.log("Respuesta recibida:", xhr.responseText);
                showNotification(
                  "Error al procesar la respuesta del servidor",
                  "error"
                );
              }
            } else {
              showNotification("Error de conexión", "error");
            }
          };

          xhr.onerror = function () {
            // Quitar clase de carga
            document
              .getElementById("register-form")
              .classList.remove("form-loading");
            showNotification("Error de conexión", "error");
          };

          // Preparar datos
          const formData =
            "name=" +
            encodeURIComponent(name) +
            "&email=" +
            encodeURIComponent(email) +
            "&telefono=" +
            encodeURIComponent(telefono) +
            "&password=" +
            encodeURIComponent(password) +
            "&confirm_password=" +
            encodeURIComponent(confirmPassword);

          // Enviar solicitud
          xhr.send(formData);
        });
    </script>

    <script src="chat.js"></script>
  </body>
</html>